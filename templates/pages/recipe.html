{% extends 'layout.html' %}

{% block body %}
{% set image_src = recipe.image if recipe and recipe.image else url_for('static', filename='media/registration.png') %}
{% set card_image = url_for('static', filename='media/registration.png') %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/recipe.css') }}">
<div class="recipe-page">
    <section class="recipe-hero">
        <div class="recipe-hero-left">
            <p class="recipe-meta">Recipe Info</p>
            <div class="recipe-title-row">
                <h1 class="recipe-title">{{ recipe.title }}</h1>
                <form action="{{ url_for('recipe', recipe_id=recipe.id) }}" method="post" class="recipe-favorite-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="toggle_favorite">
                    <button class="recipe-favorite-btn {% if recipe.is_favorited %}is-favorited{% endif %}" type="submit" aria-label="Favorite this recipe">
                        <i class="fa-solid fa-heart"></i>
                    </button>
                </form>
            </div>
            <p class="recipe-author">
                By <a href="{{ url_for('profile_view', user_id=recipe.author_id) }}">{{ recipe.author_name }}</a>
            </p>
            <div class="recipe-meta-badges">
                {% if recipe.category %}
                    <span class="recipe-badge">Category: {{ recipe.category }}</span>
                {% endif %}
                {% if recipe.difficulty %}
                    <span class="recipe-badge">Difficulty: {{ recipe.difficulty }}</span>
                {% endif %}
            </div>
            <div class="recipe-rating">
                {% set full_stars = recipe.rating|int %}
                {% set has_half = (recipe.rating - full_stars) >= 0.5 %}
                <div class="recipe-stars" aria-label="Rated {{ recipe.rating|round(1) }} out of 5">
                    {% for i in range(1, 6) %}
                        {% if i <= full_stars %}
                            <i class="fa-solid fa-star recipe-star"></i>
                        {% elif has_half and i == full_stars + 1 %}
                            <i class="fa-solid fa-star-half-stroke recipe-star"></i>
                        {% else %}
                            <i class="fa-regular fa-star recipe-star"></i>
                        {% endif %}
                    {% endfor %}
                </div>
                <span class="recipe-rating-count">({{ recipe.rating_count }})</span>
            </div>
            <div class="recipe-stats">
                {% for stat in recipe.stats %}
                    <div class="recipe-stat-card">
                        <div class="recipe-stat-value">{{ stat.value }}</div>
                        <div class="recipe-stat-label">{{ stat.label }}</div>
                    </div>
                {% endfor %}
            </div>
            <div class="recipe-hero-nutrition">
                <h3 class="recipe-hero-nutrition-title">Nutrition</h3>
                <div class="recipe-nutrition">
                    {% for item in recipe.nutrition %}
                        <div class="recipe-chip">
                            <span class="recipe-chip-value">{{ item.value }}</span>
                            <span class="recipe-chip-label">{{ item.label }}</span>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="recipe-hero-right">
            <img src="{{ image_src }}" alt="{{ recipe.title }} image" class="recipe-hero-image">
        </div>
    </section>

    <section class="recipe-section">
        <h3 class="recipe-section-title">Ingredients</h3>
        <ul class="recipe-ingredients">
            {% for ingredient in recipe.ingredients %}
                <li>{{ ingredient }}</li>
            {% endfor %}
        </ul>
    </section>

    <section class="recipe-section">
        <h3 class="recipe-section-title">Procedure</h3>
        <p class="recipe-procedure">{{ recipe.procedure }}</p>
    </section>

    <section class="recipe-section">
        <h3 class="recipe-section-title">Recipe Tags</h3>
        <div class="recipe-tags">
            {% for tag in recipe.tags %}
                <span class="recipe-tag">{{ tag }}</span>
            {% endfor %}
        </div>
    </section>

    <section class="recipe-section">
        <h3 class="recipe-section-title">Reviews</h3>
        {% if session.get('user') %}
        <form class="recipe-review add-review" method="post" action="{{ url_for('recipe', recipe_id=recipe.id) }}" id="review-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="add_review">
            <div class="recipe-review-avatar">
                <i class="fa-regular fa-circle-user"></i>
            </div>
            <div class="recipe-review-body">
                <p class="recipe-review-title">Add A Review</p>
                <div class="recipe-review-label">
                    <span>Rating (required)</span>
                    <div class="recipe-review-stars-input" data-selected="0">
                        {% for i in range(1,6) %}
                            <button type="button" class="recipe-star-btn" data-value="{{ i }}">
                                <i class="fa-solid fa-star"></i>
                            </button>
                        {% endfor %}
                        <input type="hidden" name="rating" id="review-rating" required>
                    </div>
                </div>
                <label class="recipe-review-label">
                    Comment (optional)
                    <textarea name="comment" class="recipe-review-textarea" rows="3" placeholder="Share your thoughts"></textarea>
                </label>
                <div class="recipe-review-actions">
                    <button type="submit" class="recipe-review-submit">Post Review</button>
                </div>
            </div>
        </form>
        {% else %}
            <p><a href="{{ url_for('login') }}">Log in</a> to add a review.</p>
        {% endif %}
        {% for review in recipe.reviews %}
            <div class="recipe-review">
                <div class="recipe-review-avatar">
                    <i class="fa-regular fa-circle-user"></i>
                </div>
                <div class="recipe-review-body">
                    <p class="recipe-review-author">{{ review.author }}</p>
                    <div class="recipe-review-stars">
                        {% set r_int = (review.rating or 0)|int %}
                        {% for _ in range(0, 5) %}
                            {% if loop.index <= review.rating %}
                                <i class="fa-solid fa-star"></i>
                            {% else %}
                                <i class="fa-regular fa-star"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <p class="recipe-review-text">{{ review.content }}</p>
                </div>
            </div>
            {% if not loop.last %}
                <hr class="recipe-divider">
            {% endif %}
        {% endfor %}
    </section>

    <section class="recipe-section">
        <h3 class="recipe-section-title">You May Also Like</h3>
        <div class="recipe-recommendations">
            {% if recommendations and recommendations|length > 0 %}
                {% for rec in recommendations %}
                    <a class="recipe-card" href="{{ url_for('recipe', recipe_id=rec.id) }}">
                        <div class="recipe-card__image-wrapper">
                            <img
                                class="recipe-card__image"
                                src="{{ rec.image or card_image }}"
                                alt="{{ rec.title }}"
                            >
                            <button
                                class="recipe-card__favorite {% if rec.is_favorited %}is-liked{% endif %}"
                                type="button"
                                aria-label="Save {{ rec.title }}"
                                aria-pressed="{{ 'true' if rec.is_favorited else 'false' }}"
                                data-recipe-id="{{ rec.id }}"
                                data-liked="{{ 'true' if rec.is_favorited else 'false' }}"
                                disabled
                                style="pointer-events: none;"
                            >
                                <svg class="recipe-card__favorite-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path
                                        d="M12.1 20.3a1 1 0 0 1-1.2 0C6.1 16.9 3 13.9 3 10.2 3 7.5 5.2 5 8.3 5c1.5 0 2.9.7 3.7 1.9C12.9 5.7 14.3 5 15.8 5 19 5 21 7.5 21 10.2c0 3.7-3.1 6.7-7.9 10.1z"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="1.7"
                                    />
                                </svg>
                            </button>
                        </div>
                        <div class="recipe-card__body">
                            <h3 class="recipe-card__title">{{ rec.title }}</h3>
                            <p class="recipe-card__author">{{ rec.prepare_time or 0 }} min</p>
                            <div class="recipe-card__rating" aria-label="Rated {{ rec.rating or 0 }} out of five stars">
                                {% set rating_int = (rec.rating or 0)|int %}
                                {% for _ in range(0, 5) %}
                                    <span class="rating-star {% if loop.index <= rating_int %}is-filled{% endif %}"></span>
                                {% endfor %}
                            </div>
                        </div>
                    </a>
                {% endfor %}
            {% else %}
                <p>No related recipes yet.</p>
            {% endif %}
        </div>
    </section>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const starButtons = document.querySelectorAll('.recipe-star-btn')
        const ratingInput = document.getElementById('review-rating')
        const form = document.getElementById('review-form')

        const setActiveStars = (value) => {
            starButtons.forEach((btn) => {
                const btnValue = Number(btn.dataset.value)
                btn.classList.toggle('active', btnValue <= value)
            })
        }

        starButtons.forEach((btn) => {
            btn.addEventListener('click', () => {
                const value = Number(btn.dataset.value)
                ratingInput.value = value
                ratingInput.setAttribute('value', value)
                setActiveStars(value)
            })
        })

        form?.addEventListener('submit', (e) => {
            if (!ratingInput.value) {
                e.preventDefault()
                setActiveStars(0)
            }
        })
    })
</script>
{% endblock %}
