{% extends 'layout.html' %}

{% block body%}
{% set card_image = url_for('static', filename='media/registration.png') %}
<script>
    let filter_status = "open"
    const filter_subsections_state = {
        "feed-filter-subsection-1": "open",
        "feed-filter-subsection-2": "open",
        "feed-filter-subsection-3": "open"
    }

    const set_filter_state = (is_open) => {
        const filter_section = document.getElementById("filter-section")
        const toggle_buttons = document.querySelectorAll(".feed-filter-toggle-btn")
        if (!filter_section) {
            return
        }
        filter_status = is_open ? "open" : "close"
        filter_section.classList.toggle("filters-open", is_open)
        filter_section.classList.toggle("filters-close", !is_open)
        toggle_buttons.forEach((button) => {
            button.classList.toggle("dropdown-btn-open", is_open)
            button.classList.toggle("dropdown-btn-close", !is_open)
            button.setAttribute("aria-expanded", is_open)
        })
    }

    const filter_handler = () => {
        set_filter_state(filter_status !== "open")
    }

    const toggle_subsection = (section_id) => {
        const current_state = filter_subsections_state[section_id] === "open"
        const section = document.getElementById(section_id)
        const button = document.getElementById(section_id + "-btn")
        const next_state = current_state ? "close" : "open"

        if (!section || !button) {
            return
        }

        section.classList.toggle("feed-subsection-open", next_state === "open")
        section.classList.toggle("feed-subsection-close", next_state === "close")
        button.classList.toggle("dropdown-btn-open", next_state === "open")
        button.classList.toggle("dropdown-btn-close", next_state === "close")

        filter_subsections_state[section_id] = next_state
    }

    const reset_filters = () => {
        window.location.href = "{{ url_for('feed') }}"
    }

    document.addEventListener("DOMContentLoaded", () => {
        const should_open = !window.matchMedia("(max-width: 960px)").matches
        set_filter_state(should_open)
    })
</script>
<section class="feed-page">
    <aside class="feed-filters-pane filters-open" id="filter-section">
        <div class="feed-filter-header">
            <h2 class="feed-filter-title">Filters</h2>
            <button class="feed-filter-subsection-btn feed-filter-toggle-btn dropdown-btn-open" id="feed-filter-toggle-btn"
                type="button" onclick="filter_handler()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="feed-filter-actions">
            <button class="feed-reset-btn" type="button" onclick="reset_filters()">
                Reset
            </button>
        </div>
        <form id="feed-filter-form" action="{{ url_for('feed') }}" method="get">
            <input type="hidden" name="page" value="1">
            <div class="feed-filter-dropdown">
                <div class="feed-filter-sub-section">
                    <h3 class="feed-filter-sub-title">Category</h3>
                    <button class="feed-filter-subsection-btn dropdown-btn-open" id="feed-filter-subsection-1-btn"
                        type="button" onclick="toggle_subsection('feed-filter-subsection-1')">
                        <i class="fa-solid fa-angle-right"></i>
                    </button>
                </div>
                <div class="feed-subsection-open" id="feed-filter-subsection-1">
                    {% for category in filters.categories %}
                    <label class="feed-filter-option">
                        <input type="radio" name="category" value="{{ category }}" class="feed-filter-option-input"
                            {% if active_category == category %}checked{% endif %}>
                        {{ category }}
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="feed-filter-dropdown">
                <div class="feed-filter-sub-section">
                    <h3 class="feed-filter-sub-title">Difficulty</h3>
                    <button class="feed-filter-subsection-btn dropdown-btn-open" id="feed-filter-subsection-2-btn"
                        type="button" onclick="toggle_subsection('feed-filter-subsection-2')">
                        <i class="fa-solid fa-angle-right"></i>
                    </button>
                </div>
                <div class="feed-subsection-open" id="feed-filter-subsection-2">
                    {% for difficulty in filters.difficulties %}
                    <label class="feed-filter-option">
                        <input type="radio" name="difficulty" value="{{ difficulty }}" class="feed-filter-option-input"
                            {% if active_difficulty == difficulty %}checked{% endif %}>
                        {{ difficulty }}
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="feed-filter-dropdown">
                <div class="feed-filter-sub-section">
                    <h3 class="feed-filter-sub-title">Max Time (minutes)</h3>
                    <button class="feed-filter-subsection-btn dropdown-btn-open" id="feed-filter-subsection-3-btn"
                        type="button" onclick="toggle_subsection('feed-filter-subsection-3')">
                        <i class="fa-solid fa-angle-right"></i>
                    </button>
                </div>
                <div class="feed-subsection-open" id="feed-filter-subsection-3">
                    <label class="feed-number-field">
                        <span>Up to (minutes)</span>
                        <input type="number" class="feed-number-input" name="max_time" min="0" step="5" value="{{ active_max_time }}">
                    </label>
                    <p class="feed-filter-helper">Show recipes that take no longer than this time.</p>
                </div>
            </div>

            <button class="feed-reset-btn" type="submit">Apply Filters</button>
        </form>
    </aside>
    <section class="feed-list-page">
        <div class="feed-pagination feed-pagination-top">
            {% if prev_page %}
                <a class="feed-page-btn" href="{{ url_for('feed', page=prev_page, category=active_category, difficulty=active_difficulty, max_time=active_max_time) }}">&larr; Prev</a>
            {% else %}
                <span class="feed-page-btn disabled">&larr; Prev</span>
            {% endif %}
            <span class="feed-page-status">Page {{ page }} of {{ total_pages }}</span>
            {% if next_page %}
                <a class="feed-page-btn" href="{{ url_for('feed', page=next_page, category=active_category, difficulty=active_difficulty, max_time=active_max_time) }}">Next &rarr;</a>
            {% else %}
                <span class="feed-page-btn disabled">Next &rarr;</span>
            {% endif %}
        </div>
        <div class="feed-list-actions">
            <button class="feed-mobile-filter-btn feed-filter-toggle-btn dropdown-btn-open" id="feed-filter-toggle-mobile" type="button"
                onclick="filter_handler()">
                <i class="fa-solid fa-sliders"></i>
                Filters
            </button>
        </div>
        {% if recipes and recipes|length > 0 %}
            {% for recipe in recipes %}
                    <a class="recipe-card" href="{{ url_for('recipe', recipe_id=recipe.id) }}">
                        <div class="recipe-card__image-wrapper">
                        <img
                            class="recipe-card__image lazy-image"
                            data-lazy-image
                            loading="lazy"
                            src="{{ recipe.image or card_image }}"
                            alt="{{ recipe.title }}"
                            onerror="this.onerror=null;this.src='{{ card_image }}';"
                        >
                        <button
                            class="recipe-card__favorite {% if recipe.is_favorited %}is-liked{% endif %}"
                            type="button"
                            aria-label="Save {{ recipe.title }}"
                            aria-pressed="{{ 'true' if recipe.is_favorited else 'false' }}"
                            data-recipe-id="{{ recipe.id }}"
                            data-liked="{{ 'true' if recipe.is_favorited else 'false' }}"
                        >
                            <svg class="recipe-card__favorite-icon" viewBox="0 0 24 24" aria-hidden="true">
                                <path
                                    d="M12.1 20.3a1 1 0 0 1-1.2 0C6.1 16.9 3 13.9 3 10.2 3 7.5 5.2 5 8.3 5c1.5 0 2.9.7 3.7 1.9C12.9 5.7 14.3 5 15.8 5 19 5 21 7.5 21 10.2c0 3.7-3.1 6.7-7.9 10.1z"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="1.7"
                                />
                            </svg>
                        </button>
                    </div>
                    <div class="recipe-card__body">
                        <h3 class="recipe-card__title">{{ recipe.title }}</h3>
                        <p class="recipe-card__author">{{ recipe.prepare_time or 0 }} min</p>
                        <div class="recipe-card__rating" aria-label="Rated {{ recipe.rating or 0 }} out of five stars">
                            {% set rating_int = (recipe.rating or 0)|int %}
                            {% for _ in range(0, 5) %}
                                <span class="rating-star {% if loop.index <= rating_int %}is-filled{% endif %}"></span>
                            {% endfor %}
                        </div>
                    </div>
                </a>
            {% endfor %}
        {% else %}
            <p>No recipes found for these filters.</p>
        {% endif %}

        <div class="feed-pagination feed-pagination-bottom">
            {% if prev_page %}
                <a class="feed-page-btn" href="{{ url_for('feed', page=prev_page, category=active_category, difficulty=active_difficulty, max_time=active_max_time) }}">&larr; Prev</a>
            {% else %}
                <span class="feed-page-btn disabled">&larr; Prev</span>
            {% endif %}
            <span class="feed-page-status">Page {{ page }} of {{ total_pages }}</span>
            {% if next_page %}
                <a class="feed-page-btn" href="{{ url_for('feed', page=next_page, category=active_category, difficulty=active_difficulty, max_time=active_max_time) }}">Next &rarr;</a>
            {% else %}
                <span class="feed-page-btn disabled">Next &rarr;</span>
            {% endif %}
        </div>
    </section>


</section>
{% endblock %}
