{% extends 'layout.html' %}

{% block body%}
<div class="add-page">
    <div class="add-header">
        <h1 class="add-title">Add Recipe</h1>
    </div>
    {% if error %}
        <p class="add-alert add-alert-error">{{ error }}</p>
    {% elif success %}
        <p class="add-alert add-alert-success">{{ success }}</p>
    {% endif %}
    <form class="add-form" action="{{ url_for('add') }}" method="post" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="add-field">
            <label class="add-label" for="photo">Photo</label>
            <div class="add-photo-drop">
                <div class="add-photo-text">
                    <p class="add-helper">Upload a single photo for your recipe</p>
                    <p class="add-helper">Accepted: JPG, PNG, WEBP, GIF</p>
                </div>
                <div class="add-photo-actions">
                    <label class="add-photo-btn" for="photo">Select photo</label>
                    <span class="add-helper" id="photo-filename">No file selected</span>
                </div>
                <div class="add-photo-preview" id="photo-preview-wrapper" aria-live="polite">
                    <img id="photo-preview" alt="Recipe preview" />
                </div>
                <input id="photo" name="photo" type="file" accept="image/*" style="display:none" />
            </div>
        </div>

        <div class="add-field">
            <label class="add-label" for="title">Recipe Name</label>
            <input class="add-input" id="title" name="title" type="text" placeholder="What do you call your recipe?" required>
        </div>

        <div class="add-field">
            <label class="add-label">Recipe Details</label>
            <div class="add-grid-3">
                <input class="add-input" name="category" type="text" placeholder="Category (e.g., Dinner)" required>
                <select class="add-input" name="difficulty" required>
                    <option value="" disabled selected>Select difficulty</option>
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="difficult">Difficult</option>
                </select>
            </div>
        </div>

        <div class="add-field">
            <label class="add-label">Ingredients</label>
            <div class="add-list-row">
                <div class="add-list" id="ingredients-list">
                    <div class="add-list-item">
                        <input class="add-input" name="ingredients[]" type="text" placeholder="e.g., 225g pasta" required>
                        <button class="add-remove-btn" type="button" aria-label="Remove ingredient">&minus;</button>
                    </div>
                </div>
                <button class="add-plus-btn add-inline" type="button" id="add-ingredient">+</button>
            </div>
        </div>

        <div class="add-field">
            <label class="add-label">Procedure</label>
            <textarea class="add-textarea" id="procedure" name="procedure" placeholder="Describe the full procedure" required></textarea>
        </div>

        <div class="add-field">
            <label class="add-label">Recipe Stats</label>
            <div class="add-grid-3">
                <input class="add-number" name="prep_minutes" type="number" min="0" placeholder="Minutes" required>
                <input class="add-number" name="calories" type="number" min="0" placeholder="Calories" required>
            </div>
        </div>

        <div class="add-field">
            <label class="add-label">Nutrition</label>
            <div class="add-list-row">
                <div class="add-list" id="nutrition-list">
                    <div class="add-list-item">
                        <input class="add-small-input" name="nutrition_label[]" type="text" placeholder="Label (e.g., Protein)" required>
                        <input class="add-small-input" name="nutrition_value[]" type="text" placeholder="Value (e.g., 45g)" required>
                        <button class="add-remove-btn" type="button" aria-label="Remove nutrition">&minus;</button>
                    </div>
                </div>
                <button class="add-plus-btn add-inline" type="button" id="add-nutrition">+</button>
            </div>
        </div>

        <div class="add-field">
            <label class="add-label">Recipe Tags</label>
            <div class="add-pill-row">
                <input class="add-input" id="tag-input" type="text" placeholder="Add a tag">
                <button class="add-plus-btn" type="button" id="add-tag">+</button>
            </div>
            <div class="add-tags" id="tags-container"></div>
            <input type="hidden" name="tags_serialized" id="tags-serialized">
        </div>

        <button class="add-submit" type="submit">Post Recipe</button>
    </form>
</div>

<script>
    const templateRow = (name) => {
        const wrapper = document.createElement('div')
        wrapper.className = 'add-list-item'
        if (name === 'ingredients') {
            wrapper.innerHTML = `
                <input class="add-input" name="ingredients[]" type="text" placeholder="e.g., 225g pasta" required>
                <button class="add-remove-btn" type="button" aria-label="Remove ingredient">&minus;</button>
            `
        } else {
            wrapper.innerHTML = `
                <input class="add-small-input" name="nutrition_label[]" type="text" placeholder="Label (e.g., Protein)" required>
                <input class="add-small-input" name="nutrition_value[]" type="text" placeholder="Value (e.g., 45g)" required>
                <button class="add-remove-btn" type="button" aria-label="Remove nutrition">&minus;</button>
            `
        }
        return wrapper
    }

    const addIngredientBtn = document.getElementById('add-ingredient')
    const ingredientsList = document.getElementById('ingredients-list')
    addIngredientBtn.addEventListener('click', () => {
        ingredientsList.appendChild(templateRow('ingredients'))
    })

    const addNutritionBtn = document.getElementById('add-nutrition')
    const nutritionList = document.getElementById('nutrition-list')
    addNutritionBtn.addEventListener('click', () => {
        nutritionList.appendChild(templateRow('nutrition'))
    })

    document.querySelectorAll('.add-list').forEach((listEl) => {
        listEl.addEventListener('click', (event) => {
            if (event.target.classList.contains('add-remove-btn')) {
                const parentList = event.currentTarget
                const items = parentList.querySelectorAll('.add-list-item')
                if (items.length > 1) {
                    event.target.closest('.add-list-item').remove()
                }
            }
        })
    })

    const photoInput = document.getElementById('photo')
    const photoPreview = document.getElementById('photo-preview')
    const photoPreviewWrapper = document.getElementById('photo-preview-wrapper')
    const photoFilename = document.getElementById('photo-filename')

    const updatePhotoPreview = () => {
        const file = photoInput.files && photoInput.files[0]
        if (!file) {
            photoPreviewWrapper.classList.remove('is-visible')
            photoPreview.src = ''
            photoFilename.textContent = 'No file selected'
            return
        }
        const reader = new FileReader()
        reader.onload = (e) => {
            photoPreview.src = e.target.result
            photoPreviewWrapper.classList.add('is-visible')
            photoFilename.textContent = file.name
        }
        reader.readAsDataURL(file)
    }

    photoInput.addEventListener('change', updatePhotoPreview)

    const tagsContainer = document.getElementById('tags-container')
    const tagsSerialized = document.getElementById('tags-serialized')
    const tagInput = document.getElementById('tag-input')
    const addTagBtn = document.getElementById('add-tag')
    let tags = []

    const renderTags = () => {
        tagsContainer.innerHTML = ''
        tags.forEach((tag, index) => {
            const pill = document.createElement('span')
            pill.className = 'add-tag'
            pill.innerHTML = `${tag} <button type="button" data-index="${index}">&times;</button>`
            tagsContainer.appendChild(pill)
            const hidden = document.createElement('input')
            hidden.type = 'hidden'
            hidden.name = 'tags[]'
            hidden.value = tag
            tagsContainer.appendChild(hidden)
        })
        tagsSerialized.value = JSON.stringify(tags)
    }

    addTagBtn.addEventListener('click', () => {
        const value = tagInput.value.trim()
        if (value) {
            tags.push(value)
            tagInput.value = ''
            renderTags()
        }
    })

    tagsContainer.addEventListener('click', (event) => {
        if (event.target.dataset.index) {
            tags.splice(Number(event.target.dataset.index), 1)
            renderTags()
        }
    })
</script>
{% endblock %}
