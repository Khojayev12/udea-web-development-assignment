{% extends 'layout.html' %}

{% block body%}
<div class="notifications-page">
    <div class="notifications-header">
        <h1 class="notifications-title">Notifications</h1>
        <div class="notifications-actions">
            <button class="notifications-btn" id="notifications-mark-all">Mark all as read</button>
        </div>
    </div>
    <div class="notifications-list">
        {% if notifications and notifications|length > 0 %}
            {% for item in notifications %}
                {% set initial = (item.actor_name or 'N')[:1] | upper %}
                <article class="notification-card" data-notification-id="{{ item.id }}">
                    <div class="notification-avatar">
                        <span>{{ initial }}</span>
                    </div>
                    <div class="notification-body">
                        <p class="notification-heading">
                            <span class="notification-name">{{ item.actor_name }}</span>
                            {% if item.type == 'follow' %}
                                started following you
                            {% elif item.type == 'rating' %}
                                rated/commented on your recipe {% if item.recipe_title %}“{{ item.recipe_title }}”{% endif %}
                            {% elif item.type == 'recipe_status' %}
                                update on your recipe {% if item.recipe_title %}“{{ item.recipe_title }}”{% endif %}
                            {% else %}
                                sent a notification
                            {% endif %}
                        </p>
                        {% if item.message %}
                            <p class="notification-message">{{ item.message }}</p>
                        {% endif %}
                        <p class="notification-time">
                            {{ item.created_at.strftime('%Y-%m-%d %H:%M') if item.created_at else '' }}
                        </p>
                    </div>
                    <div class="notification-side">
                        <div class="notification-thumb notification-thumb--placeholder">
                            <span class="notification-thumb-placeholder-icon"><i class="fa-regular fa-bell"></i></span>
                        </div>
                        <button class="notifications-btn notification-card-btn" type="button">Mark as read</button>
                    </div>
                </article>
            {% endfor %}
        {% endif %}
        <p class="notifications-empty" id="notifications-empty">You are all caught up.</p>
    </div>
</div>
<script>
    const listEl = document.querySelector('.notifications-list')
    const emptyEl = document.getElementById('notifications-empty')
    const markAllBtn = document.getElementById('notifications-mark-all')

    const updateEmptyState = () => {
        const hasCards = listEl.querySelectorAll('.notification-card').length > 0
        emptyEl.style.display = hasCards ? 'none' : 'block'
    }

    listEl.addEventListener('click', async (event) => {
        if (!event.target.classList.contains('notification-card-btn')) return
        const card = event.target.closest('.notification-card')
        if (card) {
            const id = card.dataset.notificationId
            if (!id) return
            const formData = new FormData()
            formData.append('notification_id', id)
            const res = await fetch("{{ url_for('notifications_mark_read') }}", { method: 'POST', body: formData })
            if (res.ok) {
                card.remove()
                updateEmptyState()
            }
        }
    })

    markAllBtn.addEventListener('click', async () => {
        const res = await fetch("{{ url_for('notifications_mark_all') }}", { method: 'POST' })
        if (res.ok) {
            listEl.querySelectorAll('.notification-card').forEach((card) => card.remove())
            updateEmptyState()
        }
    })

    updateEmptyState()
</script>
{% endblock %}
